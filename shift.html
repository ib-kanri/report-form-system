<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト提出</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 10px; }
        .month-selector { margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        .month-selector input { padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        .month-selector button { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .month-selector button:hover { background: #1557b0; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-box .label { font-size: 14px; color: #666; }
        .stat-box .value { font-size: 24px; font-weight: bold; color: #1a73e8; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 500; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        select, input[type="time"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .sunday { color: #d32f2f; }
        .saturday { color: #1976d2; }
        .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .button-group button { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-cancel { background: #f5f5f5; color: #333; }
        .btn-submit { background: #1a73e8; color: white; }
        .btn-submit:hover { background: #1557b0; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .message { padding: 12px; border-radius: 4px; margin: 20px 0; text-align: center; display: none; }
        .message.error { background: #fce8e6; color: #c5221f; }
        .message.success { background: #e6f4ea; color: #1e8e3e; }
        .message.show { display: block; }
        .loading { text-align: center; display: none; }
        .loading.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>シフト提出</h1>
        <p style="color: #666; margin-bottom: 20px;"><span id="userName"></span></p>

        <div class="month-selector">
            <label>対象年月:</label>
            <input type="month" id="targetMonth">
            <button onclick="loadShift()">読み込み</button>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="label">稼働日数</div>
                <div class="value" id="workDays">0日</div>
            </div>
            <div class="stat-box">
                <div class="label">公休</div>
                <div class="value" id="holidays">0日</div>
            </div>
            <div class="stat-box">
                <div class="label">有給</div>
                <div class="value" id="paidLeave">0日</div>
            </div>
        </div>

        <div id="message" class="message"></div>
        <div id="loading" class="loading">送信中...</div>

        <form id="shiftForm" onsubmit="submitShift(event)">
            <table>
                <thead>
                    <tr>
                        <th style="width:100px">日付</th>
                        <th style="width:120px">勤務区分</th>
                        <th style="width:100px">開始時刻</th>
                        <th style="width:100px">終了時刻</th>
                        <th style="width:100px">休憩(分)</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>

            <div class="button-group">
                <button type="button" class="btn-cancel" onclick="location.href='menu.html'">キャンセル</button>
                <button type="submit" class="btn-submit" id="submitBtn">提出</button>
            </div>
        </form>
    </div>

    <script>
        const SCRIPT_URL = 'https://interblue-proxy.k-hamada-ib.workers.dev/';
        const employeeId = sessionStorage.getItem('employeeId');
        const employeeName = sessionStorage.getItem('employeeName');

        if (!employeeId) location.href = 'index.html';
        document.getElementById('userName').textContent = employeeName;

        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        const defaultYM = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('targetMonth').value = defaultYM;

        let currentYearMonth = defaultYM;
        generateCalendar(defaultYM);

        async function loadShift() {
            const ym = document.getElementById('targetMonth').value;
            if (!ym) {
                showMessage('対象年月を選択してください', 'error');
                return;
            }
            currentYearMonth = ym;
            await generateCalendar(ym);
        }

        async function generateCalendar(yearMonth) {
            const [year, month] = yearMonth.split('-').map(Number);
            const days = new Date(year, month, 0).getDate();
            const tbody = document.getElementById('calendarBody');
            tbody.innerHTML = '';

            // 既存データ取得
            let existing = {};
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'getShift', employeeId, yearMonth})
                });
                const result = await res.json();
                if (result.success && result.data) {
                    result.data.forEach(s => {
                        existing[s.date] = s;
                    });
                }
            } catch (e) {
                console.log('既存データ取得エラー:', e);
            }

            for (let day = 1; day <= days; day++) {
                const date = new Date(year, month - 1, day);
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dow = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                const isSun = date.getDay() === 0;
                const isSat = date.getDay() === 6;

                const ex = existing[dateStr];
                const wt = ex ? ex.workType : (isSun ? '公休' : '出勤');
                const st = ex ? ex.startTime : (isSun ? '' : '10:00');
                const et = ex ? ex.endTime : (isSun ? '' : '19:00');
                const bt = ex ? ex.breakTime : (isSun ? '' : '60');

                const tr = document.createElement('tr');
                tr.dataset.date = dateStr;
                tr.innerHTML = `
                    <td class="${isSun ? 'sunday' : ''} ${isSat ? 'saturday' : ''}">${month}/${day}(${dow})</td>
                    <td><select onchange="updateStats()">
                        <option value="出勤" ${wt==='出勤'?'selected':''}>出勤</option>
                        <option value="公休" ${wt==='公休'?'selected':''}>公休</option>
                        <option value="有給" ${wt==='有給'?'selected':''}>有給</option>
                    </select></td>
                    <td><input type="time" value="${st}"></td>
                    <td><input type="time" value="${et}"></td>
                    <td><input type="number" min="0" value="${bt}" onchange="updateStats()"></td>
                `;
                tbody.appendChild(tr);
            }
            updateStats();
        }

        function updateStats() {
            let work = 0, holiday = 0, paid = 0;
            document.querySelectorAll('#calendarBody tr').forEach(tr => {
                const wt = tr.querySelector('select').value;
                if (wt === '出勤') work++;
                else if (wt === '公休') holiday++;
                else if (wt === '有給') paid++;
            });
            document.getElementById('workDays').textContent = work + '日';
            document.getElementById('holidays').textContent = holiday + '日';
            document.getElementById('paidLeave').textContent = paid + '日';
        }

        async function submitShift(e) {
            e.preventDefault();
            
            const shifts = [];
            document.querySelectorAll('#calendarBody tr').forEach(tr => {
                const dateStr = tr.dataset.date;
                const date = new Date(dateStr);
                const dow = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                shifts.push({
                    date: dateStr,
                    workType: tr.querySelector('select').value,
                    startTime: tr.querySelectorAll('input')[0].value || '',
                    endTime: tr.querySelectorAll('input')[1].value || '',
                    breakTime: tr.querySelectorAll('input')[2].value || ''
                });
            });

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('loading').classList.add('show');
            document.getElementById('message').classList.remove('show');

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'saveShift',
                        data: {employeeId, employeeName, yearMonth: currentYearMonth, shifts}
                    })
                });

                const result = await res.json();

                if (result.success) {
                    showMessage('シフトを提出しました', 'success');
                    setTimeout(() => location.href = 'menu.html', 2000);
                } else {
                    showMessage(result.message, 'error');
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch (error) {
                showMessage('通信エラーが発生しました', 'error');
                document.getElementById('submitBtn').disabled = false;
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function showMessage(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type + ' show';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    </script>
</body>
</html>
